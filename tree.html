<!doctype html>

<html lang='en'>

  <head>
    <title>Stellar Desk</title>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <meta name='description' content='Stellar Desk | The dashboard for all things Stellar!'>
    <meta name='subject' content='Stellar'>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name='mobile-web-app-capable' content='yes'>

    <!-- Add to homescreen for Safari on iOS -->
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-status-bar-style' content='black'>
    <meta name='apple-mobile-web-app-title' content='Stellar Desk'>
    <link rel='apple-touch-icon-precomposed' href='favicon.png'>

    <link rel='icon' href='favicon.png'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Montserrat:500|Material+Icons'>
    <link rel='stylesheet' href='material.blue-red.min.css'>
    <link rel='stylesheet' href='style.css'>
  </head>

  <body>

    <div class='mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header'>

      <!-- ---------------------------------------------------------------------- -->
      <header class='mdl-layout__header'> <!-- 1.1 mdl-layout__header! -->
        <div class='mdl-layout__header-row'>

          <h1 id='title0' class='mdl-typography--title montserrat'>Stellar Desk <div id='clock0'></div></h1>

          <div class='mdl-layout-spacer'></div>

          <button id='btn_horizon' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white'></button>

          <div class='mdl-textfield mdl-js-textfield mdl-textfield--expandable'>
            <label id='btn_search' class='mdl-button mdl-js-button mdl-button--icon' for='page_search'><i class='material-icons'>search</i></label>
            <div class='mdl-textfield__expandable-holder width_256px'>
              <input class='mdl-textfield__input text_search' id='page_search' type='text'/>
              <label class='mdl-textfield__label text_search' for='page_search'>Search account by <b>ID</b></label>
            </div>
            <div class='mdl-tooltip mdl-tooltip--large' for='btn_search'>Search account by <b>ID</b></div>
          </div>

        </div>
      </header>

      <!-- ---------------------------------------------------------------------- -->
      <div class='mdl-layout__drawer demo-drawer'> <!-- 1.2 mdl-layout__drawer! -->

        <header class='demo-drawer-header mdl-color--grey-900'>  <!-- Top-left dark corner! -->
          <a href='/'><img src='mathisart_small.png' class='demo-avatar'/></a>

          <div class='demo-avatar-dropdown'>
            <div class='mdl-layout-spacer'></div>
            <button id='accbtn' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white'><div class='material-icons'>arrow_drop_down</div></button>

            <ul class='mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect' for='accbtn'>
              <a class='mdl-menu__item' href='https://stellar.org'>Stellar.org</a>
              <a class='mdl-menu__item' href='https://www.stellar.org/developers/'>Developers</a>
              <a class='mdl-menu__item' href='https://github.com/stellar'>Github</a>
              <a class='mdl-menu__item' href='https://stellarchain.io/'>StellarChain</a>
              <a class='mdl-menu__item' href='https://galactictalk.org/'>Forums</a>
              <a class='mdl-menu__item' href='https://etale-cohomology.github.io/stellar-tutorials/'>Tutorials</a>
            </ul>
          </div>
        </header>

        <nav class='mdl-navigation mdl-color--blue'>
          <a class='mdl-navigation__link' href='accounts?server=pubnet'><div class='material-icons'>accessibility</div>Accounts</a>
          <a class='mdl-navigation__link' href='ledgers?server=pubnet'><div class='material-icons'>view_week</div>Ledgers</a>
          <a class='mdl-navigation__link' href='transactions?server=pubnet'><div class='material-icons'>change_history</div>Transactions</a>
          <a class='mdl-navigation__link' href='operations?server=pubnet'><div class='material-icons'>dashboard</div>Operations</a>
          <a class='mdl-navigation__link' href='effects?server=pubnet'><div class='material-icons'>gesture</div>Effects</a>
          <a class='mdl-navigation__link' href='payments?server=pubnet'><div class='material-icons'>payment</div>Payments</a>
          <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link' href='markets'><div class='material-icons'>equalizer</div>Markets</a>
          <a class='mdl-navigation__link' href='wallet?server=testnet'><div class='material-icons'>fingerprint</div>Wallet</a>
          <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link mdl-color--grey-900' href='tree?server=pubnet'><div class='material-icons'>share</div>Account tree</a>
          <!-- <a class='mdl-navigation__link' href='quorum?server=pubnet'><div class='material-icons'>blur_circular</div>Quorum</a> -->
          <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link' href='https://github.com/etale-cohomology/stellardesk'><div class='material-icons'>business</div>Source</a>

          <!-- <div class='mdl-layout-spacer'></div>
          <a class='mdl-navigation__link' href='docs'><i class='material-icons'>help_outline</i></a> -->
        </nav>

      </div>

      <!-- ---------------------------------------------------------------------- -->
      <main class='mdl-layout__content'>

        <!-- --------------------- -->
        <div class='mdl-grid'>

          <div class='mdl-cell mdl-cell--12-col vcenter_parent'>
            <h1 id='account_title' class='mdl-typography--title inline_block vcenter_child'></h1>
            <button class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--grey-500 inline_block vcenter_child' id='help_tree'><i class='material-icons'>help_outline</i></button>
            <div class='mdl-tooltip' for='help_tree'>In Stellar, every account is created by some account. This page shows a view of the accounts <b>created</b> by a given account. <i>Double click</i> on a node in the graph to go to that account's view.</div>
          </div>

          <div class='mdl-cell mdl-cell--4-col flex_justify_center'>
            <div class='mdl-card mdl-shadow--2dp card_major'>
              <div class='mdl-card__title card_major'><div class='mdl-card__title-text card_major'>Children known</div></div>
              <div id='accounts_known' class='mdl-card__supporting-text card_major'>0</div>
            </div>
          </div>

          <div class='mdl-cell mdl-cell--4-col flex_justify_center'>
            <div class='mdl-card mdl-shadow--2dp card_major'>
              <div class='mdl-card__title card_major'><div class='mdl-card__title-text card_major'>Children found</div></div>
              <div id='accounts_found' class='mdl-card__supporting-text card_major'>0</div>
            </div>
          </div>

          <div class='mdl-cell mdl-cell--4-col flex_justify_center'>
            <div class='mdl-card mdl-shadow--2dp card_major'>
              <div class='mdl-card__title card_major'><div class='mdl-card__title-text card_major'>Showing last N children</div></div>
              <div id='accounts_shown' class='mdl-card__supporting-text card_major'>0</div>
              <!-- <div class='mdl-card__title'><div class='mdl-card__title-text card_minor'>accounts</div></div> -->
            </div>
          </div>

        </div>

        <!-- --------------------- -->
        <div class='mdl-grid'>

          <div id='canvas_container' class='mdl-cell mdl-cell--12-col horizontal_scroll'>
            <canvas id='canvas_springy'></canvas>
          </div>

        </div>

        <!-- --------------------- -->
        <div id='snackbar_error' class='mdl-snackbar mdl-js-snackbar mdl-color--red'>
          <div class='mdl-snackbar__text'></div><button class='mdl-snackbar__action' type='button'></button>
        </div>

      </main>

    </div>

  </body>

  <script src='stellar-sdk.min.js'></script>
  <script src='material.min.js'></script>
  <script src='main.js'></script>

  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js'></script>
  <script src='springy.js'></script>
  <script src='springyui.js'></script>
  <script>
    // ------------------------------------------------------------------------------------------------
    // Hide main title on search icon click!

    let page_search = doc.querySelector('#page_search')

    page_search.onfocus = function(event){
      doc.querySelector('#title0').style.display = 'none'
      doc.querySelector('#btn_horizon').style.display = 'none'
    }

    page_search.onblur = function(event){
      doc.querySelector('#title0').style.display = ''
      doc.querySelector('#btn_horizon').style.display = ''
    }

    page_search.onkeypress = function(event){
      if(event.keyCode == 13)  window.location = `/tree?server=${doc.querySelector('#btn_horizon').innerText.toLowerCase()}&account=${this.value}`
    }


    // ---------------------------------------------------------------------------------------------------
    let canvas = doc.querySelector('#canvas_springy')
    let canvas_container = doc.querySelector('#canvas_container')
    canvas.width = canvas_container.offsetWidth * .96  // window.innerWidth
    canvas.height = window.innerHeight * .9  // window.innerHeight

    let GRAPH = new Springy.Graph()

    // ----------------------------------------------------------------------
    function account_titles_set(account_id){
      doc.querySelector('#account_title').innerText = `Tree of account creation: ${account_id}`
    }


    // ---------------------------------------------------------------------------------------------------
    function account_search(account_id){
      if(!account_id)  return
      HORIZON.accounts().accountId(account_id).call().then(account_get).catch(account_error)
    }

    function account_get(account){
      let springy = jQuery('#canvas_springy').springy({graph: GRAPH})

      account_titles_set(account.id)
      doc.querySelector('#accounts_known').innerText = account.subentry_count
      return HORIZON.operations().forAccount(account.id).order('desc').limit(200).call()
        .then(account_operations)
        .then(account_operations)
        .then(account_operations)
        .then(account_operations)
        .then(account_operations)
        .then(account_operations_last)
    }

    function account_operations(response){
      let operations = response.records
      let account_so_far = parseInt(doc.querySelector('#accounts_found').innerText)
      let n_created_accounts = get_operations(operations, 'create_account', account_so_far)
      doc.querySelector('#accounts_found').innerText = account_so_far + n_created_accounts
      return response.next()
    }

    function get_operations(operations, operation_type, account_so_far){
      print('account_so_far', account_so_far)
      let count = 0
      for(let operation of operations){

        if(operation.type == operation_type){
          count++
          // print([operation.account, operation.starting_balance, operation.funder])

          if((account_so_far + count) <= MAX_ACCOUNTS_SHOW)
            if(operation.account != account_id){
              let location = `/tree?server=${doc.querySelector('#btn_horizon').innerText.toLowerCase()}&account=${operation.account}`
              let child_node = GRAPH.newNode({label: operation.account, ondoubleclick: function(){ window.location = location}})
              GRAPH.newEdge(GRAPH_ACCOUNT_ROOT, child_node, {label: 'child', color: '#2196f3'})
            }else{
              let location = `/tree?server=${doc.querySelector('#btn_horizon').innerText.toLowerCase()}&account=${operation.funder}`
              let parent_node = GRAPH.newNode({label: operation.funder, ondoubleclick: function(){ window.location = location}})
              GRAPH.newEdge(GRAPH_ACCOUNT_ROOT, parent_node, {label: 'parent', color: '#f44336'})
            }

        }

      }
      return count
    }

    function account_operations_last(){
      let n_accounts_found = parseInt(doc.querySelector('#accounts_found').innerText) - 1
      doc.querySelector('#accounts_found').innerText = n_accounts_found
      doc.querySelector('#accounts_shown').innerText = Math.min(n_accounts_found, MAX_ACCOUNTS_SHOW)
    }

    function account_error(error){
      let snackbar_div = doc.querySelector('#snackbar_error')
      let snackbar_data = {message: 'Error when searching account!'}
      snackbar_div.MaterialSnackbar.showSnackbar(snackbar_data)
    }

    // ---------------------------------------------------------------------------------------------------
    // GAECJVZ55YDSVO7KYNWSTFFTGF4AJ7DJH6O6WTTR33KCA2UBT4KOKBLY
    horizon_btn()

    let MAX_ACCOUNTS_SHOW = 32

    let account_id = url_get('account')
    let GRAPH_ACCOUNT_ROOT = GRAPH.newNode({label: account_id})
    account_search(account_id)
  </script>

</html>
