<!doctype html>

<html lang='en'>

  <head>
    <title>Stellar Desk</title>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <meta name='description' content='Stellar Desk | The dashboard for all things Stellar!'>
    <meta name='subject' content='Stellar'>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name='mobile-web-app-capable' content='yes'>

    <!-- Add to homescreen for Safari on iOS -->
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-status-bar-style' content='black'>
    <meta name='apple-mobile-web-app-title' content='Stellar Desk'>
    <link rel='apple-touch-icon-precomposed' href='favicon.png'>

    <link rel='icon' href='favicon.png'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Montserrat:500|Material+Icons'>
    <link rel='stylesheet' href='material.blue-red.min.css'>
    <link rel='stylesheet' href='style.css'>
  </head>

  <body>

    <div class='mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer'>  <!-- 1. mdl-layout! -->

      <!-- ---------------------------------------------------------------------- -->
      <header class='mdl-layout__header'> <!-- 1.1 mdl-layout__header! -->
        <div class='mdl-layout__header-row'>

          <h1 id='title0' class='mdl-typography--title montserrat'>Stellar Desk <div id='clock0'></div></h1>

          <div class='mdl-layout-spacer'></div>

          <button id='btn_horizon' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-color-text--white'></button>

          <div class='mdl-textfield mdl-js-textfield mdl-textfield--expandable'>
            <label id='btn_search' class='mdl-button mdl-js-button mdl-button--icon' for='page_search'><i class='material-icons'>search</i></label>
            <div class='mdl-textfield__expandable-holder width_256px'>
              <input class='mdl-textfield__input text_search' id='page_search' type='text'/>
              <label class='mdl-textfield__label text_search' for='page_search'>Search ledger by <b>sequence</b></label>
            </div>
            <div class='mdl-tooltip mdl-tooltip--large' for='btn_search'>Search ledger by <b>sequence</b></div>
          </div>

        </div>
      </header>

      <!-- ---------------------------------------------------------------------- -->
      <div class='mdl-layout__drawer demo-drawer'> <!-- 1.2 mdl-layout__drawer! -->

        <header class='demo-drawer-header mdl-color--grey-900'>  <!-- Top-left dark corner! -->
          <a href='/'><img src='mathisart_small.png' class='demo-avatar'/></a>

          <div class='demo-avatar-dropdown'>
            <div class='mdl-layout-spacer'></div>
            <button id='accbtn' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color-text--white'><div class='material-icons'>arrow_drop_down</div></button>

            <ul class='mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect' for='accbtn'>
              <a class='mdl-menu__item' href='https://stellar.org'>Stellar.org</a>
              <a class='mdl-menu__item' href='https://www.stellar.org/developers/'>Developers</a>
              <a class='mdl-menu__item' href='https://github.com/stellar'>Github</a>
              <a class='mdl-menu__item' href='https://stellarchain.io/'>StellarChain</a>
              <a class='mdl-menu__item' href='https://galactictalk.org/'>Forums</a>
              <a class='mdl-menu__item' href='https://etale-cohomology.github.io/stellar-tutorials/'>Tutorials</a>
            </ul>
          </div>
        </header>

        <nav class='mdl-navigation mdl-color--blue'>
          <a class='mdl-navigation__link' href='accounts?server=pubnet'><div class='material-icons'>accessibility</div>Accounts</a>
          <a class='mdl-navigation__link mdl-color--grey-900' href='ledgers?server=pubnet'><div class='material-icons'>view_week</div>Ledgers</a>
          <a class='mdl-navigation__link' href='transactions?server=pubnet'><div class='material-icons'>change_history</div>Transactions</a>
          <a class='mdl-navigation__link' href='operations?server=pubnet'><div class='material-icons'>dashboard</div>Operations</a>
          <a class='mdl-navigation__link' href='effects?server=pubnet'><div class='material-icons'>gesture</div>Effects</a>
          <a class='mdl-navigation__link' href='payments?server=pubnet'><div class='material-icons'>payment</div>Payments</a>
          <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link' href='markets'><div class='material-icons'>equalizer</div>Markets</a>
          <a class='mdl-navigation__link' href='wallet?server=testnet'><div class='material-icons'>fingerprint</div>Wallet</a>
          <!-- <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link' href='qourum?server=pubnet'><div class='material-icons'>share</div>Account tree</a>
          <a class='mdl-navigation__link' href='tree?server=pubnet'><div class='material-icons'>blur_circular</div>Quorum</a> -->
          <hr class='mdl-color--white border_none'>
          <a class='mdl-navigation__link' href='https://github.com/etale-cohomology/stellardesk'><div class='material-icons'>business</div>Source</a>

          <!-- <div class='mdl-layout-spacer'></div>
          <a class='mdl-navigation__link' href='docs'><i class='material-icons'>help_outline</i></a> -->
        </nav>

      </div>

      <!-- ---------------------------------------------------------------------- -->
      <main class='mdl-layout__content mdl-color--grey-100'>  <!-- 1.3 mdl-layout__content! -->

        <div class='mdl-grid'>

          <div class='mdl-cell mdl-cell--12-col'>
            <h1 class='mdl-typography--title montserrat inline'>Ledgers</h1>
            <div id='spinner_main' class='mdl-spinner mdl-js-spinner margin_left4 is-active'></div>
          </div>

          <!-- <div class='mdl-cell mdl-cell--6-col'>
            <div class='mdl-card mdl-shadow--2dp inline'>Page XX</div>
            <button id='btn_prev' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored mdl-button--raised margin_left min_width'>Prev</button>
            <button id='btn_next' class='mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored mdl-button--raised margin_left min_width'>Next</button>
          </div> -->

          <div class='mdl-cell mdl-cell--4-col flex_justify_center'>
            <div class='mdl-card mdl-shadow--2dp card_major'> <!-- ------- -->
              <div class='mdl-card__title card_major'><div id='ledgers_secs_title' class='mdl-card__title-text card_major'>Avg. secs per ledger (last ? ledgers)</div></div>
              <div id='ledgers_secs' class='mdl-card__supporting-text card_major'>NA</div>
            </div>
          </div>

          <div class='mdl-cell mdl-cell--4-col flex_justify_center'>
            <div class='mdl-card mdl-shadow--2dp card_major'> <!-- ------- -->
              <div class='mdl-card__title card_major'><div id='ledgers_txs_title' class='mdl-card__title-text card_major'>Avg. transactions per ledger (last ? ledgers)</div></div>
              <div id='ledgers_txs' class='mdl-card__supporting-text card_major'>NA</div>
            </div>
            </div>

          <div class='mdl-cell mdl-cell--4-col flex_justify_center'>
            <div class='mdl-card mdl-shadow--2dp card_major'> <!-- ------- -->
              <div class='mdl-card__title card_major'><div id='ledgers_ops_title' class='mdl-card__title-text card_major'>Avg. operations per ledger (last ? ledgers)</div></div>
              <div id='ledgers_ops' class='mdl-card__supporting-text card_major'>NA</div>
            </div>
          </div>

          <div class='mdl-cell mdl-cell--12-col'>
            <div class='horizontal_scroll'>
              <table id='ledgers_table' class='mdl-data-table mdl-js-data-table mdl-shadow--2dp hcenter'>
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>

      </main>

    </div>

  </body>

  <script src='material.min.js'></script>
  <script src='stellar-sdk.min.js'></script>
  <script src='main.js'></script>
  <script>
    // ------------------------------------------------------------------------------------------------
    // Hide main title on search icon click!

    let page_search = doc.querySelector('#page_search')

    page_search.onfocus = function(event){
      doc.querySelector('#title0').style.display = 'none'
      doc.querySelector('#btn_horizon').style.display = 'none'
    }

    page_search.onblur = function(event){
      doc.querySelector('#title0').style.display = ''
      doc.querySelector('#btn_horizon').style.display = ''
    }

    page_search.onkeypress = function(event){
      if(event.keyCode == 13)  window.location = `/ledger?server=${doc.querySelector('#btn_horizon').innerText.toLowerCase()}&sequence=${this.value}`
    }


    // ---------------------------------------------------------------------------------------------------
    function Ledger(cursor=null, order=null, limit=null){
      this.cursor = cursor
      this.order = order
      this.limit = limit
    }

    function ledgers_get(ledger){
      HORIZON.ledgers().cursor(ledger.cursor).order(ledger.order).limit(ledger.limit).call().then(ledgers_callback).catch(error_show)
    }

    function ledgers_callback(response){
      ledger_stream_init(response)  // Start the streaming updates!
      table_head_build('#ledgers_table', LEDGERS_HEADERS)
      table_rows_build('#ledgers_table', ledger.limit)
      table_object_build('#ledgers_table', response.records, ledger_get, LEDGERS_HEADERS)  // Build initial table!
      spinner_disable('spinner_main')

      // --------------------- Add links!
      let rows = doc.querySelector('#ledgers_table').tBodies[0].rows
      let horizon = doc.querySelector('#btn_horizon').innerText.toLowerCase()
      for(let i=0; i<rows.length; ++i){
        let cells = rows[i].cells
        for(let j=0; j<cells.length; ++j)
          cells[j].innerHTML = `<a href='ledger?server=${horizon}&sequence=${response.records[i].sequence}'>${cells[j].innerText}</a>`
      }
    }

    function ledger_stream_init(response){
      ledger_eventsource = HORIZON.ledgers().cursor('now').stream({onmessage: ledger_stream})
    }

    function ledger_stream(response){
      table_object_update('#ledgers_table', response, ledger_get, LEDGERS_HEADERS)

      // --------------------- Add links!
      let cells = doc.querySelector('#ledgers_table').tBodies[0].rows[0].cells
      for(let i=0; i<cells.length; ++i)
        cells[i].innerHTML = `<a href='ledger?server=${doc.querySelector('#btn_horizon').innerText.toLowerCase()}&sequence=${response.sequence}'>${cells[i].innerText}</a>`

      // ---------------------
      let table_rows = doc.querySelector('#ledgers_table').tBodies[0].rows
      ledgers_avg_secs(table_rows)
      ledgers_avg_txs(table_rows)
      ledgers_avg_ops(table_rows)
    }

    // ----------------------------------------------------------------------
    function ledgers_avg_secs(table_rows){
      ledgers_secs = []
      for(let i=0; i < (table_rows.length-1); ++i){
        let secs = datestr_to_secs(table_rows[i].cells[0].innerText) - datestr_to_secs(table_rows[i+1].cells[0].innerText)
        ledgers_secs.push(secs)
      }
      doc.querySelector('#ledgers_secs_title').innerText = `Avg. seconds per ledger (last ${ledger.limit-1} ledgers)`
      doc.querySelector('#ledgers_secs').innerText = `${parseFloat(average(ledgers_secs)).toFixed(2)}`
    }

    function ledgers_avg_txs(table_rows){
      ledgers_txs = []
      for(let i=0; i < table_rows.length; ++i){
        let secs = parseInt(table_rows[i].cells[6].innerText)
        ledgers_txs.push(secs)
      }
      doc.querySelector('#ledgers_txs_title').innerText = `Avg. transactions per ledger (last ${ledger.limit} ledgers)`
      doc.querySelector('#ledgers_txs').innerText = `${parseFloat(average(ledgers_txs)).toFixed(2)}`
    }

    function ledgers_avg_ops(table_rows){
      ledgers_ops = []
      for(let i=0; i < table_rows.length; ++i){
        let secs = parseInt(table_rows[i].cells[7].innerText)
        ledgers_ops.push(secs)
      }
      doc.querySelector('#ledgers_ops_title').innerText = `Avg. operations per ledger (last ${ledger.limit} ledgers)`
      doc.querySelector('#ledgers_ops').innerText = `${parseFloat(average(ledgers_ops)).toFixed(2)}`
    }


    // ----------------------------------------------------------------------
    horizon_btn()

    let ledger = new Ledger(null, 'desc', 32)
    ledgers_get(ledger)
  </script>

</html>
